<% layout('layout') -%>
<h2>Search Books</h2>
<form class="searchbar" method="get" action="/search">
  <input type="text" name="q" placeholder="Search by title..." value="<%= q %>"/>
  <button class="btn" type="submit">Search</button>
</form>

<div class="grid" style="margin-top:12px;">
  <% books.forEach(b => { %>
    <div class="card">
      <strong><%= b.title %></strong><br/>
      <span><%= b.author || '' %></span><br/>
      <small><%= b.isbn || '' %></small><br/>
      <% if (b.available) { %>
        <% if (user) { %>
          <form method="post" action="/books/<%= b._id %>/borrow">
            <input type="hidden" name="days" value="14"/>
            <button class="btn" type="submit">Borrow</button>
          </form>
        <% } else { %>
          <a class="btn secondary" href="/login">Login to borrow</a>
        <% } %>
      <% } else { %>
        <div>Borrowed. Due: <%= b.dueDate ? new Date(b.dueDate).toLocaleDateString() : '-' %></div>
        <% if (user && String(b.borrowedBy) === String(user._id)) { %>
          <form method="post" action="/books/<%= b._id %>/return">
            <button class="btn" type="submit">Return</button>
          </form>
        <% } %>
      <% } %>
    </div>
  <% }) %>
</div>
